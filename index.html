<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Audio Scrambler Pro + Visualizer</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --primary: #007bff;
            --success: #28a745;
            --danger: #dc3545;
            --text-main: #212529;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 15px;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh;
        }

        .container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 20px;
            width: 100%; max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
        }

        h1 { text-align: center; color: var(--primary); font-size: 1.4rem; margin-top: 0; }

        /* Estilos del Visualizador */
        .canvas-container {
            background: #e9ecef;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            height: 80px;
            display: flex; align-items: center;
        }
        canvas { width: 100%; height: 60px; }

        .status-badge {
            text-align: center; font-size: 0.85rem; font-weight: 600;
            padding: 6px; border-radius: 6px; background: #f1f3f5; margin-bottom: 15px;
        }

        input[type="text"] {
            width: 100%; padding: 14px; margin-bottom: 15px;
            border: 2px solid #dee2e6; border-radius: 10px;
            font-size: 16px; box-sizing: border-box; outline: none;
        }

        input[type="text"]:focus { border-color: var(--primary); }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        button {
            padding: 16px; border: none; border-radius: 10px;
            font-weight: bold; cursor: pointer; transition: 0.2s;
        }

        .btn-record { background: var(--danger); color: white; }
        .btn-stop { background: #6c757d; color: white; }
        .btn-action { background: var(--success); color: white; }
        .btn-download { background: var(--primary); color: white; grid-column: span 2; margin-top: 10px; }
        button:disabled { background: #dee2e6 !important; color: #adb5bd; }

        .footer { font-size: 0.75rem; text-align: center; color: #999; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üéôÔ∏è Scrambler Pro</h1>
    
    <div class="canvas-container">
        <canvas id="visualizer"></canvas>
    </div>

    <div class="status-badge" id="status">Listo para operar</div>

    <input type="text" id="passphrase" placeholder="Tu clave de cifrado">

    <div class="grid">
        <button id="btnRecord" class="btn-record">Grabar</button>
        <button id="btnStop" class="btn-stop" disabled>Parar</button>
    </div>

    <input type="file" id="fileInput" accept="audio/*" style="margin: 15px 0; width: 100%;">

    <div class="grid">
        <button id="btnScramble" class="btn-action" disabled>Codificar</button>
        <button id="btnDescramble" class="btn-action" disabled>Decodificar</button>
        <button id="btnDownload" class="btn-download" disabled>Descargar .WAV</button>
    </div>

    <div class="footer">
        Conexi√≥n Segura HTTPS Detectada ‚úÖ<br>
        v2.0 PWA Enabled
    </div>
</div>

<script>
    let audioContext, analyser, dataArray, animationId;
    let recordedBuffer, lastProcessedBuffer, mediaRecorder, audioChunks = [];

    const canvas = document.getElementById('visualizer');
    const canvasCtx = canvas.getContext('2d');
    const status = document.getElementById('status');

    // Inicializar Audio y Visualizador
    function initAudio() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
        }
        if (audioContext.state === 'suspended') audioContext.resume();
    }

    function draw() {
        animationId = requestAnimationFrame(draw);
        analyser.getByteTimeDomainData(dataArray);

        canvasCtx.fillStyle = '#e9ecef';
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        canvasCtx.lineWidth = 3;
        canvasCtx.strokeStyle = '#007bff';
        canvasCtx.beginPath();

        let sliceWidth = canvas.width * 1.0 / dataArray.length;
        let x = 0;

        for (let i = 0; i < dataArray.length; i++) {
            let v = dataArray[i] / 128.0;
            let y = v * canvas.height / 2;
            if (i === 0) canvasCtx.moveTo(x, y);
            else canvasCtx.lineTo(x, y);
            x += sliceWidth;
        }
        canvasCtx.lineTo(canvas.width, canvas.height / 2);
        canvasCtx.stroke();
    }

    // --- GRABACI√ìN ---
    document.getElementById('btnRecord').onclick = async () => {
        initAudio();
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser); // Conectar micro al visualizador
            
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            draw(); // Iniciar dibujo

            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                cancelAnimationFrame(animationId);
                const blob = new Blob(audioChunks);
                const arrayBuffer = await blob.arrayBuffer();
                recordedBuffer = await audioContext.decodeAudioData(arrayBuffer);
                document.getElementById('btnScramble').disabled = false;
                document.getElementById('btnDescramble').disabled = false;
                status.innerText = "Audio listo";
            };

            mediaRecorder.start();
            document.getElementById('btnRecord').disabled = true;
            document.getElementById('btnStop').disabled = false;
            status.innerText = "üî¥ GRABANDO...";
        } catch (e) {
            alert("Error de micr√≥fono. Revisa el HTTPS.");
        }
    };

    document.getElementById('btnStop').onclick = () => {
        mediaRecorder.stop();
        document.getElementById('btnRecord').disabled = false;
        document.getElementById('btnStop').disabled = true;
    };

    // --- L√ìGICA DE SCRAMBLING ---
    function process(isEncrypt) {
        initAudio();
        const key = document.getElementById('passphrase').value;
        if (!key) return alert("Introduce una clave");

        let channelData = recordedBuffer.getChannelData(0);
        let frameSize = 1024;
        let totalFrames = Math.floor(channelData.length / frameSize);
        let indices = [...Array(totalFrames).keys()];

        let hash = CryptoJS.SHA256(key).toString();
        for (let i = totalFrames - 1; i > 0; i--) {
            let j = Math.floor((hash.charCodeAt(i % hash.length) / 255) * (i + 1));
            [indices[i], indices[j]] = [indices[j], indices[i]];
        }

        let newBuffer = audioContext.createBuffer(1, recordedBuffer.length, audioContext.sampleRate);
        let newData = newBuffer.getChannelData(0);

        for (let i = 0; i < totalFrames; i++) {
            let src = isEncrypt ? i : indices[i];
            let dst = isEncrypt ? indices[i] : i;
            for (let j = 0; j < frameSize; j++) {
                if (dst * frameSize + j < newData.length)
                    newData[dst * frameSize + j] = channelData[src * frameSize + j];
            }
        }

        lastProcessedBuffer = newBuffer;
        document.getElementById('btnDownload').disabled = false;
        
        let play = audioContext.createBufferSource();
        play.buffer = newBuffer;
        play.connect(audioContext.destination);
        play.start();
        status.innerText = isEncrypt ? "Codificado con √©xito" : "Decodificado con √©xito";
    }

    document.getElementById('btnScramble').onclick = () => process(true);
    document.getElementById('btnDescramble').onclick = () => process(false);

    // --- CARGA Y DESCARGA ---
    document.getElementById('fileInput').onchange = async (e) => {
        initAudio();
        const file = e.target.files[0];
        if (!file) return;
        const arrayBuffer = await file.arrayBuffer();
        recordedBuffer = await audioContext.decodeAudioData(arrayBuffer);
        document.getElementById('btnScramble').disabled = false;
        document.getElementById('btnDescramble').disabled = false;
        status.innerText = "Archivo cargado";
    };

    document.getElementById('btnDownload').onclick = () => {
        const wav = bufferToWave(lastProcessedBuffer, lastProcessedBuffer.length);
        const url = URL.createObjectURL(wav);
        const a = document.createElement('a');
        a.href = url; a.download = "mensaje_seguro.wav"; a.click();
    };

    function bufferToWave(abuffer, len) {
        let length = len * 2 + 44, buffer = new ArrayBuffer(length), view = new DataView(buffer), pos = 0;
        const set16 = (d) => { view.setInt16(pos, d, true); pos += 2; };
        const set32 = (d) => { view.setUint32(pos, d, true); pos += 4; };
        set32(0x46464952); set32(length - 8); set32(0x45564157); set32(0x20746d66); set32(16);
        set16(1); set16(1); set32(abuffer.sampleRate); set32(abuffer.sampleRate * 2);
        set16(2); set16(16); set32(0x61746164); set32(length - pos - 4);
        let data = abuffer.getChannelData(0);
        for(let i=0; i<data.length; i++) {
            let s = Math.max(-1, Math.min(1, data[i]));
            set16(s < 0 ? s * 0x8000 : s * 0x7FFF);
        }
        return new Blob([buffer], {type: "audio/wav"});
    }

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
</script>
</body>
</html>
